var Bulldozer=new function(){this.fn=Object.getPrototypeOf(this),this.utils,this.init=function(e,o){Bulldozer.loadingIndicator.show(),Bulldozer.socket.init(e,o),Kepler.init()}};Bulldozer.utils={escapeData:function(e){return e.toString().replace(/\\|&/g,"\\$&")},showErrorMessageBox:function(e,o,n){e=Kepler.utils.escapeHTML(e),o=Kepler.utils.escapeHTML(o);var t='<div class="topbar alert"><div class="icon"></div><div class="title"><h3>'+e+'</h3></div></div><div class="kepler grid"><div class="large-12 column"><p>'+o+"</p>";n&&(t+="<br><code>"+Kepler.utils.escapeHTML(n)+"</code>"),t+='</div><div class="large-12 column"><hr></hr></div><div class="large-12 column"><a class="kepler button expand close-modal">OK</a></div></div>',this.addAndShowTmpModal(t,{closable:!1,zIndex:10001})},addAndShowTmpModal:function(e,o){var n=$.extend({domId:!1,closable:!0,"class":"radius shadow",zIndex:"auto"},o);if(!e)return void console.log("error: addAndShowTmpModal: body is invalid!");var t=$('<div class="kepler modal"></div>');if(n.class&&t.addClass(n.class.toString()),n.domId&&t.attr("id",n.domId.toString()),t.append(e),n.closable){var i='<a class="close-modal">&#215;</a>',r=t.find(".topbar:first");r.length>0?r.append(i):t.prepend(i)}t.appendTo($("body")),Kepler.modal.open(t,{closeOnBackdropClick:n.closable,removeOnClose:!0,zIndex:n.zIndex}),Kepler.init()}},Bulldozer.fn.loadingIndicator=new function(){var e=!1,o=!1,n=function(){e!==!1&&(clearTimeout(e),e=!1)};this.show=function(){var t=$("#bud-loading-indicator");o||(o=!0,n(),t.removeClass("none-pointer-events"),t.css("opacity","0").show(),e=setTimeout(function(){e=!1,t.css("opacity","1").addClass("show"),e=setTimeout(function(){e=!1,Bulldozer.loadingIndicator.hide(),Bulldozer.utils.showErrorMessageBox("Error","Failed to perform the request. Timeout reached. Please try again...")},25e3)},1e3))},this.hide=function(){var t=$("#bud-loading-indicator");o&&(o=!1,n(),t.removeClass("show").addClass("none-pointer-events"),e=setTimeout(function(){e=!1,t.hide()},2e3))}},Bulldozer.fn.connectionLost=new function(){var e=!1,o=!1,n=!1,t=function(){e!==!1&&(clearTimeout(e),e=!1)},i=function(){o!==!1&&clearTimeout(o),o=setTimeout(function(){o=!1,$("#bud-connection-lost .click-to-reconnect").removeClass("connecting fail success")},1500)};this.show=function(){var o=$("#bud-connection-lost");n||(n=!0,t(),e=setTimeout(function(){e=!1,o.show().addClass("show")},700))},this.hide=function(){var o=$("#bud-connection-lost");n&&(n=!1,t(),o.removeClass("show"),e=setTimeout(function(){e=!1,o.hide()},3e3))},this.connectionLost=function(){return n},this.reconnectFailed=function(){var e=$("#bud-connection-lost .click-to-reconnect");e.hasClass("connecting")&&!e.hasClass("fail")&&(e.addClass("fail"),i())},this.reconnectSuccess=function(){var e=$("#bud-connection-lost .click-to-reconnect");e.hasClass("success")||(e.addClass("success"),i())},$(function(){$("#bud-connection-lost .click-to-reconnect").click(function(){var e=$(this);e.hasClass("connecting")||(e.addClass("connecting"),Bulldozer.socket.reconnect(),i())})})},Bulldozer.fn.WebSocket=new function(){var e;this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"websocket"},this.open=function(){try{var o="ws://";"https:"===window.location.protocol&&(o="wss://"),o+=window.location.host+"/bulldozer/ws",e=new WebSocket(o),e.onmessage=function(e){Bulldozer.WebSocket.onMessage(e.data.toString())},e.onerror=function(){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()},e.onclose=function(){Bulldozer.WebSocket.onClose&&Bulldozer.WebSocket.onClose()},e.onopen=function(){Bulldozer.WebSocket.onOpen()}}catch(n){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()}},this.send=function(o){e.send(o)},this.reset=function(){e&&e.close(),e=void 0}},Bulldozer.fn.AjaxSocket=new function(){var e,o,n=7e3,t=45e3,i=!1,r=!1,s={Init:"init"},l=function(){i&&i.abort(),r&&r.abort()},a=function(){l(),Bulldozer.AjaxSocket.onError()},c=function(){i=$.ajax({url:"/bulldozer/ajax/poll",success:function(e){i=!1;var n=e.indexOf("&");return 0>n?(console.log("ajaxsocket: failed to split poll token from data! '&' not found! data: "+e),void a()):(o=e.substring(0,n),e=e.substr(n+1),c(),void Bulldozer.AjaxSocket.onMessage(e))},error:function(){i=!1,a()},type:"POST",data:e+"&"+o,dataType:"text",timeout:t})},d=function(e,o){r=$.ajax({url:"/bulldozer/ajax",success:function(e){r=!1,o&&o(e)},error:function(){r=!1,a()},type:"POST",data:e,dataType:"text",timeout:n})};this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"ajaxsocket"},this.open=function(){d(s.Init,function(n){var t=n.indexOf("&");return 0>t?(console.log("ajaxsocket: failed to split uid and poll token from data! '&' not found! data: "+n),void a()):(e=n.substring(0,t),o=n.substr(t+1),c(),void Bulldozer.AjaxSocket.onOpen())})},this.send=function(o){d(e+"&"+o)},this.reset=function(){l()}},Bulldozer.fn.socket=new function(){var e,o,n,t=3,i={Task:"tsk"},r={InvalidRequest:"invalid_request",RefreshRequest:"req_refresh",Ping:"ping",Pong:"pong"},s=!1,l=!1,a=!1,c=0,d=[],u=!1,f=function(o){return"sid="+e+"&tok="+n+"&"+o},h=function(){a!==!1&&(clearTimeout(a),a=!1)},v=function(){u!==!1&&(clearTimeout(u),u=!1)},g=function(){v(),u=setTimeout(function(){u=!1,d=[]},6e3)},p=function(){a!==!1&&clearTimeout(a),Bulldozer.connectionLost.hide(),a=setTimeout(function(){a=!1,Bulldozer.connectionLost.show()},6e4)},m=function(e){if(p(),e){if(e===r.InvalidRequest)return void console.log("The server replied with an invalid request notification! The previous request was invalid!");var o=e.indexOf("&");if(0>o)return void Bulldozer.utils.showErrorMessageBox("Error","Warning! Invalid data received from server! Please reload this webpage and notify the site administrator!","Error data: '"+e+"'");if(n=e.substring(0,o),e=e.substr(o+1),e===r.Ping)return void l.send(f(i.Task+"="+r.Pong+"&"));if(e)try{jQuery.globalEval(e)}catch(t){console.log("failed to execute request: "+t.message)}}},b=function(e){if(!e)return console.log("Failed to initialize socket session! Received emtpy data from server!"),!1;if(e===r.InvalidRequest)return console.log("The server replied with an invalid request notification! The previous request was invalid!"),!1;var t=e.split("&");return t.length<2?(console.log("Failed to initialize socket session! Received list length is invalid: '"+e+"'"),!1):(o=t[0],n=t[1],c=0,p(),Bulldozer.connectionLost.reconnectSuccess(),Bulldozer.connectionLost.hide(),!0)},z=function(){Bulldozer.connectionLost.show(),Bulldozer.connectionLost.reconnectFailed(),h();var e=!1;c+=1,t>=c?setTimeout(function(){Bulldozer.socket.reconnect(e)},1500):(console.log("giving up..."),Bulldozer.connectionLost.show())};this.hasSocket=function(){return!(l===!1)},this.sessionID=function(){return e},this.init=function(o,t,i){if(!o||!t)return void console.log("empty session ID or socket access token!");h(),e=o,n=t;var r=0,a=function(){l&&(l.onOpen=void 0,l.onClose=void 0,l.onMessage=void 0,l.onError=void 0,l.reset(),l=!1,r=300)};a(),setTimeout(function(){l=window.WebSocket&&i!==!0?Bulldozer.WebSocket:Bulldozer.AjaxSocket,l.onOpen=function(){l.send(f(""))},l.onClose=function(){z()},l.onError=function(){console.log(l.type()+": a connection error occurred!"),z()},l.onMessage=function(e){if(!b(e))return a(),void z();v();for(var o=d.length,n=0;o>n;n++)l.send(f(d[n]));d=[],s||(s=!0,$(document).triggerHandler("bulldozer.ready")),l.onMessage=m},l.open()},r)},this.send=function(e,o){var n=i.Task+"="+String(e)+"&";for(var t in o)o.hasOwnProperty(t)&&(n+=t+"="+Bulldozer.utils.escapeData(o[t])+"&");return Bulldozer.connectionLost.connectionLost()?(d.push(n),g(),Bulldozer.socket.reconnect(),!1):(l.send(f(n)),!0)},this.reconnect=function(e){$.ajax({url:"/bulldozer/reconnect",type:"POST",data:{id:o},dataType:"text",timeout:7e3,success:function(o){if(o===r.RefreshRequest)return void window.location.reload();var n=o.split("&");return n.length<2?(console.log("Failed to reconnect socket session! Received list length is invalid: '"+o+"'"),void Bulldozer.utils.showErrorMessageBox("Error","Failed to reconnect to server! Please reload this webpage and try again...")):void Bulldozer.socket.init(n[0],n[1],e)},error:function(){console.log("failed to reconnect to server!"),z()}})}},Bulldozer.fn.core=new function(){var e,o=!1,n=[],t=[],i={};$(document).on("bulldozer.ready",function(){o=!0,Bulldozer.core.execJsLoad()}),$(document).on("click","a",function(e){var o=String($(this).attr("href"));return"mailto:"===o.slice(0,7)?(e.preventDefault(),window.open(o,"_blank"),!1):Bulldozer.socket.hasSocket()&&this.host===window.location.host&&"#"!==o.slice(0,1)&&"public/"!==o.slice(0,7)&&"/public/"!==o.slice(0,8)?(e.preventDefault(),o&&Bulldozer.core.navigate(o),!1):void 0}),this.navigateToDefault=function(){this.navigate("/")},this.navigate=function(e){Bulldozer.loadingIndicator.show();var o={path:e};Bulldozer.socket.send("route",o)},this.emit=function(){if(arguments.length<2)return void console.log("Bulldozer.emit: Invalid arguments passed! The emit function requires a DOM ID and key parameter!");for(var e={did:arguments[0],key:arguments[1]},o=2;o<arguments.length;o++)e["arg"+(o-1)]=arguments[o];Bulldozer.socket.send("emit",e)},this.loadStyleSheet=function(e){$('<link rel="stylesheet" type="text/css" href="'+e+'">').appendTo("head")},this.loadScript=function(e,o){var t={url:e,callback:o};n.push(t);var i=function(e,o){var t={dataType:"script",cache:!0,url:e},r=function(){n.length>0?i(n[0].url,n[0].callback):Bulldozer.core.execJsLoad()};jQuery.ajax(t).done(function(){n.shift(),o&&o(),r()}).fail(function(o,t,i){n.shift(),Bulldozer.utils.showErrorMessageBox("Error","Failed to load script '"+e+"'. Please contact the site administrator!","Error message: "+String(i)),r()})};n.length<=1&&($.isReady?i(e,o):$(document).ready(function(){i(e,o)}))},$(window).on("beforeunload",function(){return e?e:void 0}),this.setExitMessage=function(o){e=String(o)},this.resetExitMessage=function(){e=""},this.execJsLoad=function(e){setTimeout(function(){n.length>0||!o?e&&t.push(e.toString()):($.each(t,function(e,o){$("#"+o).triggerHandler("bulldozer.execJsLoad")}),t=[],e&&$("#"+e).triggerHandler("bulldozer.execJsLoad"),setTimeout(function(){Bulldozer.loadingIndicator.hide()},50))},10)},this.onJsLoad=function(e,o){$("#"+e).one("bulldozer.execJsLoad",function(){try{o()}catch(e){console.log("execute js load function error: "+e.message)}})},this.execJsUnload=function(e){$("#"+e).triggerHandler("bulldozer.execJsUnload")},this.onJsUnload=function(e,o){var n=function(){try{o()}catch(e){console.log("execute js unload function error: "+e.message)}};$("#"+e).one("bulldozer.execJsUnload",n),$(document).one("bulldozer.execJsUnload",n)},this.addServerEvent=function(e,o,n){var t=$("#"+e);if(t.length<=0)return void console.log("addServerEvent: element with id '"+e+"' does not exists!");var i=t.data("bulldozerserverevents");i||(i={}),i[o]=n,t.data("bulldozerserverevents",i)},this.emitServerEvent=function(e,o){var n=$("#"+e);if(n.length<=0)return void console.log("emitServerEvent: element with id '"+e+"' does not exists!");var t=n.data("bulldozerserverevents");if(!t)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");if(func=t[o],!func)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");try{var i=Array.prototype.slice.call(arguments,2);func.apply(n,i)}catch(r){console.log("execute server event error: "+r.message)}},this.addGlobalServerEvent=function(e,o){i[e]=o},this.clearGlobalServerEvents=function(){i={}},this.emitGlobalServerEvent=function(e){var o=i[e];if(!o)return void console.log("emitGlobalServerEvent: event with key '"+e+"' does not exists!");try{var n=Array.prototype.slice.call(arguments,1);o.apply(document,n)}catch(t){console.log("execute global server event error: "+t.message)}}},Bulldozer.fn.auth=new function(){this.hashPassword=function(e,o){return CryptoJS.SHA256(CryptoJS.SHA256(e)+Bulldozer.socket.sessionID()+o).toString()}},Bulldozer.fn.render=new function(){var e,o=!1;$(window).on("statechange",function(){if(!o){var e=History.getState().hash;e||(e="/"),Bulldozer.core.navigate(e)}}),this.updateTemplate=function(e,o){var n=$("#"+e);return n.length<=0?void Bulldozer.utils.showErrorMessageBox("Error","Failed to update template: '"+e+"'. Try to reload the page and please contact the site administrator!"):(Bulldozer.core.execJsUnload(e),n.removeData().replaceWith(o),void Kepler.init())},this.page=function(n,t,i){$(document).triggerHandler("bulldozer.execJsUnload"),Bulldozer.core.clearGlobalServerEvents();var r=$("#bud-body");r&&r.length>0&&(r.off(),r.find("*").off());var s,l;$("body").children().each(function(){s=$(this),l=s.attr("id"),"bud-loading-indicator"===l||"bud-body"===l||"bud-connection-lost"===l||s.is("noscript")&&s.has("#bud-noscript")||$(this).remove()}),$("html, body").removeAttr("style"),Bulldozer.topbar.space();var a=$('<div id="bud-body"></div>');a.append(n),r.replaceWith(a),window.scrollTo(0,0),i&&e!==i&&(e=i,o=!0,History.pushState(null,null,i),o=!1),document.title=t,Kepler.init()}},Bulldozer.fn.data=new function(){var e={};this.set=function(o,n){e[o]=n},this.delete=function(o){delete e[o]},this.get=function(o){return e[o]},this.getAndReply=function(o,n){var t=e[o];t||(t="");var i={key:o,rand:n,data:t};Bulldozer.socket.send("clientData",i)}},Bulldozer.fn.topbar=new function(){var e="0";this.space=function(o){o===!0?e="45px":o===!1&&(e="0"),$("body").css("margin-top",e),$(".bud-topbar-auto-move").css("margin-top",e)}};