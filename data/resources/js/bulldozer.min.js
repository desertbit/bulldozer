var Bulldozer=new function(){this.fn=Object.getPrototypeOf(this),this.utils};Bulldozer.utils={escapeData:function(e){return e.toString().replace(/\\|&/g,"\\$&")},showErrorMessageBox:function(e,o,n){e=Kepler.utils.escapeHTML(e),o=Kepler.utils.escapeHTML(o);var t='<div class="topbar alert"><div class="icon"></div><div class="title"><h3>'+e+'</h3></div></div><div class="kepler grid"><div class="large-12 column"><p>'+o+"</p>";n&&(t+="<br><code>"+Kepler.utils.escapeHTML(n)+"</code>"),t+='</div><div class="large-12 column"><hr></hr></div><div class="large-12 column"><a class="kepler button expand close-modal">OK</a></div></div>',this.addAndShowTmpModal(t,{closable:!1,zIndex:10001})},addAndShowTmpModal:function(e,o){var n=$.extend({domId:!1,closable:!0,"class":"radius shadow",zIndex:"auto"},o);if(!e)return void console.log("error: addAndShowTmpModal: body is invalid!");var t=$('<div class="kepler modal"></div>');if(n.class&&t.addClass(n.class.toString()),n.domId&&t.attr("id",n.domId.toString()),t.append(e),n.closable){var i='<a class="close-modal">&#215;</a>',r=t.find(".topbar:first");r.length>0?r.append(i):t.prepend(i)}t.appendTo($("body")),Kepler.modal.open(t,{closeOnBackdropClick:n.closable,removeOnClose:!0,zIndex:n.zIndex}),Kepler.init()}},Bulldozer.fn.loadingIndicator=new function(){var e=!1,o=!1,n=function(){e!==!1&&(clearTimeout(e),e=!1)};this.show=function(){var t=$("#bulldozer-loading-indicator");o||(o=!0,n(),t.css("opacity","0").show(),e=setTimeout(function(){e=!1,t.css("opacity","1").addClass("show")},1e3))},this.hide=function(){var t=$("#bulldozer-loading-indicator");o&&(o=!1,n(),t.removeClass("show"),e=setTimeout(function(){e=!1,t.hide()},2e3))}},Bulldozer.fn.connectionLost=new function(){var e=!1,o=!1,n=!1,t=function(){e!==!1&&(clearTimeout(e),e=!1)},i=function(){o!==!1&&clearTimeout(o),o=setTimeout(function(){o=!1,$("#bulldozer-connection-lost .click-to-reconnect").removeClass("connecting fail success")},1500)};this.show=function(){var o=$("#bulldozer-connection-lost");n||(n=!0,t(),e=setTimeout(function(){e=!1,o.show().addClass("show")},700))},this.hide=function(){var o=$("#bulldozer-connection-lost");n&&(n=!1,t(),o.removeClass("show"),e=setTimeout(function(){e=!1,o.hide()},3e3))},this.connectionLost=function(){return n},this.reconnectFailed=function(){var e=$("#bulldozer-connection-lost .click-to-reconnect");e.hasClass("connecting")&&!e.hasClass("fail")&&(e.addClass("fail"),i())},this.reconnectSuccess=function(){var e=$("#bulldozer-connection-lost .click-to-reconnect");e.hasClass("success")||(e.addClass("success"),i())},$(function(){$("#bulldozer-connection-lost .click-to-reconnect").click(function(){var e=$(this);e.hasClass("connecting")||(e.addClass("connecting"),Bulldozer.socket.reconnect(),i())})})},Bulldozer.fn.WebSocket=new function(){var e;this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"websocket"},this.open=function(){try{var o="ws://";"https:"===window.location.protocol&&(o="wss://"),o+=window.location.host+"/bulldozer/ws",e=new WebSocket(o),e.onmessage=function(e){Bulldozer.WebSocket.onMessage(e.data.toString())},e.onerror=function(){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()},e.onclose=function(){Bulldozer.WebSocket.onClose&&Bulldozer.WebSocket.onClose()},e.onopen=function(){Bulldozer.WebSocket.onOpen()}}catch(n){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()}},this.send=function(o){e.send(o)},this.reset=function(){e&&e.close(),e=void 0}},Bulldozer.fn.AjaxSocket=new function(){var e,o,n=7e3,t=45e3,i=!1,r=!1,l={Init:"init"},s=function(){i&&i.abort(),r&&r.abort()},a=function(){s(),Bulldozer.AjaxSocket.onError()},c=function(){i=$.ajax({url:"/bulldozer/ajax/poll",success:function(e){i=!1;var n=e.indexOf("&");return 0>n?(console.log("ajaxsocket: failed to split poll token from data! '&' not found! data: "+e),void a()):(o=e.substring(0,n),e=e.substr(n+1),c(),void Bulldozer.AjaxSocket.onMessage(e))},error:function(){i=!1,a()},type:"POST",data:e+"&"+o,dataType:"text",timeout:t})},d=function(e,o){r=$.ajax({url:"/bulldozer/ajax",success:function(e){r=!1,o&&o(e)},error:function(){r=!1,a()},type:"POST",data:e,dataType:"text",timeout:n})};this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"ajaxsocket"},this.open=function(){d(l.Init,function(n){var t=n.indexOf("&");return 0>t?(console.log("ajaxsocket: failed to split uid and poll token from data! '&' not found! data: "+n),void a()):(e=n.substring(0,t),o=n.substr(t+1),c(),void Bulldozer.AjaxSocket.onOpen())})},this.send=function(o){d(e+"&"+o)},this.reset=function(){s()}},Bulldozer.fn.socket=new function(){var e,o,n,t,i=3,r={Task:"tsk"},l={InvalidRequest:"invalid_request",Ping:"ping",Pong:"pong"},s=!1,a=!1,c=0,d=function(e){return"sid="+o+"&tok="+t+"&"+e},u=function(){a!==!1&&clearTimeout(a),Bulldozer.connectionLost.hide(),a=setTimeout(function(){a=!1,Bulldozer.connectionLost.show()},4e4)},f=function(o){if(o){if(o===l.InvalidRequest)return void console.log("The server replied with an invalid request notification! The previous request was invalid!");var n=o.indexOf("&");if(0>n)return void Bulldozer.utils.showErrorMessageBox("Error","Warning! Invalid data received from server! Please reload this webpage and notify the site administrator!","Error data: '"+o+"'");if(t=o.substring(0,n),o=o.substr(n+1),o===l.Ping)return e.send(d(r.Task+"="+l.Pong+"&")),void u();o&&jQuery.globalEval(o)}},h=function(e){if(!e)return console.log("Failed to initialize socket session! Received emtpy data from server!"),!1;if(e===l.InvalidRequest)return console.log("The server replied with an invalid request notification! The previous request was invalid!"),!1;var o=e.split("&");return o.length<2?(console.log("Failed to initialize socket session! Received list length is invalid: '"+e+"'"),!1):(n=o[0],t=o[1],c=0,Bulldozer.connectionLost.reconnectSuccess(),Bulldozer.connectionLost.hide(),!0)},v=function(){Bulldozer.connectionLost.show(),Bulldozer.connectionLost.reconnectFailed();var o=!1;c+=1,c==i&&e.type()!==Bulldozer.AjaxSocket.type()&&(console.log("falling back to ajax socket..."),o=!0),i>=c?setTimeout(function(){Bulldozer.socket.reconnect(o)},1500):(console.log("giving up..."),Bulldozer.connectionLost.show())};this.init=function(n,i,r){return n&&i?(o=n,t=i,e&&(e.onOpen=void 0,e.onClose=void 0,e.onMessage=void 0,e.onError=void 0,e.reset()),e=window.WebSocket&&r!==!0?Bulldozer.WebSocket:Bulldozer.AjaxSocket,e.onOpen=function(){e.send(d(""))},e.onClose=function(){v()},e.onError=function(){console.log(e.type()+": a connection error occurred!"),v()},e.onMessage=function(o){return h(o)?(s||(s=!0,$(document).triggerHandler("bulldozer.ready")),void(e.onMessage=function(e){f(e)})):void Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize web session! Please reload this webpage and try again...")},void e.open()):void console.log("empty session ID or socket access token!")},this.send=function(o,n){if(Bulldozer.connectionLost.connectionLost())return Bulldozer.socket.reconnect(),!1;var t=r.Task+"="+String(o)+"&";for(var i in n)n.hasOwnProperty(i)&&(t+=i+"="+Bulldozer.utils.escapeData(n[i])+"&");return e.send(d(t)),!0},this.reconnect=function(e){$.ajax({url:"/bulldozer/reconnect",type:"POST",data:{id:n},dataType:"text",timeout:7e3,success:function(o){var n=o.split("&");return n.length<2?(console.log("Failed to reconnect socket session! Received list length is invalid: '"+o+"'"),void Bulldozer.utils.showErrorMessageBox("Error","Failed to reconnect to server! Please reload this webpage and try again...")):void Bulldozer.socket.init(n[0],n[1],e)},error:function(){console.log("failed to reconnect to server!"),v()}})}},Bulldozer.fn.core=new function(){var e,o=!1,n=[],t=[],i={};$(document).on("bulldozer.ready",function(){o=!0,Bulldozer.core.execJsLoad()}),$(document).on("click","a",function(e){var o=String($(this).attr("href"));return"mailto:"===o.slice(0,7)?(e.preventDefault(),window.open(o,"_blank"),!1):this.host===window.location.host&&"#"!==o.slice(0,1)&&"public/"!==o.slice(0,6)&&"/public/"!==o.slice(0,7)?(e.preventDefault(),o&&Bulldozer.core.loadPage(o),!1):void 0}),this.loadDefaultPage=function(){this.loadPage("/")},this.loadPage=function(e){Bulldozer.loadingIndicator.show();var o={path:e};Bulldozer.socket.send("page",o)},this.emit=function(){if(arguments.length<2)return void console.log("Bulldozer.emit: Invalid arguments passed! The emit function requires a DOM ID and key parameter!");for(var e={did:arguments[0],key:arguments[1]},o=2;o<arguments.length;o++)e["arg"+(o-1)]=arguments[o];Bulldozer.socket.send("emit",e)},this.loadStyleSheet=function(e){$('<link rel="stylesheet" type="text/css" href="'+e+'">').appendTo("head")},this.loadScript=function(e,o){var t={url:e,callback:o};n.push(t);var i=function(e,o){var t={dataType:"script",cache:!0,url:e},r=function(){n.length>0?i(n[0].url,n[0].callback):Bulldozer.core.execJsLoad()};jQuery.ajax(t).done(function(){n.shift(),o&&o(),r()}).fail(function(o,t,i){n.shift(),Bulldozer.utils.showErrorMessageBox("Error","Failed to load script '"+e+"'. Please contact the site administrator!","Error message: "+String(i)),r()})};n.length<=1&&i(e,o)},$(window).on("beforeunload",function(){return e?e:void 0}),this.setExitMessage=function(o){e=String(o)},this.resetExitMessage=function(){e=""},this.execJsLoad=function(e){setTimeout(function(){n.length>0||!o?e&&t.push(e.toString()):($.each(t,function(e,o){$("#"+o).triggerHandler("bulldozer.execJsLoad")}),t=[],e&&$("#"+e).triggerHandler("bulldozer.execJsLoad"),setTimeout(function(){Bulldozer.loadingIndicator.hide()},50))},10)},this.onJsLoad=function(e,o){$("#"+e).one("bulldozer.execJsLoad",o)},this.execJsUnload=function(e){$("#"+e).triggerHandler("bulldozer.execJsUnload")},this.onJsUnload=function(e,o){$("#"+e).one("bulldozer.execJsUnload",o),$(document).one("bulldozer.execJsUnload",o)},this.addServerEvent=function(e,o,n){var t=$("#"+e);if(t.length<=0)return void console.log("addServerEvent: element with id '"+e+"' does not exists!");var i=t.data("bulldozerserverevents");i||(i={}),i[o]=n,t.data("bulldozerserverevents",i)},this.emitServerEvent=function(e,o){var n=$("#"+e);if(n.length<=0)return void console.log("emitServerEvent: element with id '"+e+"' does not exists!");var t=n.data("bulldozerserverevents");if(!t)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");if(func=t[o],!func)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");var i=Array.prototype.slice.call(arguments,2);func.apply(n,i)},this.addGlobalServerEvent=function(e,o){i[e]=o},this.emitGlobalServerEvent=function(e){if(func=i[e],!func)return void console.log("emitGlobalServerEvent: event with key '"+e+"' does not exists!");var o=Array.prototype.slice.call(arguments,1);func.apply(document,o)}},Bulldozer.fn.render=new function(){var e,o,n=!1,t=!1;$(window).on("statechange",function(){if(!n){var e=History.getState().hash;e||(e="/"),Bulldozer.core.loadPage(e)}});var i=function(){var e=$("#bulldozer-body");t||(e.replaceWith('<div id="bulldozer-body"></div>'),e=$("#bulldozer-body"),t=!0),$("#bulldozer-top").length<=0&&e.append('<div id="bulldozer-top"></div>'),$("#bulldozer-pages-body").length<=0&&e.append('<div id="bulldozer-pages-body"></div>'),$("#bulldozer-bottom").length<=0&&e.append('<div id="bulldozer-bottom"></div>')};this.currentPageUrl=function(){return o},this.updateTemplate=function(e,o){var n=$("#"+e);return n.length<=0?void Bulldozer.utils.showErrorMessageBox("Error","Failed to update template: '"+e+"'. Try to reload the page and please contact the site administrator!"):(Bulldozer.core.execJsUnload(e),n.replaceWith(o),void Kepler.init())},this.top=function(e){var o=$("#bulldozer-top");o.length<=0&&(i(),o=$("#bulldozer-top")),o.html(e)},this.bottom=function(e){var o=$("#bulldozer-bottom");o.length<=0&&(i(),o=$("#bulldozer-bottom")),o.html(e)},this.page=function(t,r,l,s){$(document).triggerHandler("bulldozer.execJsUnload"),$(".bulldozer-page").remove(),e&&e.length>0&&(e.off(),e.find("*").off());var a;if($("body").children().each(function(){a=$(this).attr("id"),"bulldozer-loading-indicator"!==a&&"bulldozer-body"!==a&&$(this).remove()}),$("#bulldozer-pages-body > #"+t).length>0)$("#"+t).replaceWith(r);else{var c=$("#bulldozer-pages-body");c.length<=0&&(i(),c=$("#bulldozer-pages-body")),c.append(r)}e=$("#"+t),e.show(),window.scrollTo(0,0),s&&o!==s&&(o=s,n=!0,History.pushState(null,null,s),n=!1),document.title=l,Kepler.init()}};