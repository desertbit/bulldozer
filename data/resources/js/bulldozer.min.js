var Bulldozer=new function(){this.fn=Object.getPrototypeOf(this),this.utils};Bulldozer.utils={escapeData:function(e){return e.toString().replace(/\\|&/g,"\\$&")},showErrorMessageBox:function(e,o,t){e=Kepler.utils.escapeHTML(e),o=Kepler.utils.escapeHTML(o);var n='<div class="topbar alert"><div class="icon"></div><div class="title"><h3>'+e+'</h3></div></div><div class="kepler grid"><div class="large-12 column"><p>'+o+"</p>";t&&(n+="<br><code>"+Kepler.utils.escapeHTML(t)+"</code>"),n+='</div><div class="large-12 column"><hr></hr></div><div class="large-12 column"><a class="kepler button expand close-modal">OK</a></div></div>',this.addAndShowTmpModal(n,{closable:!1,zIndex:10001})},addAndShowTmpModal:function(e,o){var t=$.extend({domId:!1,closable:!0,"class":"radius shadow",zIndex:"auto"},o);if(!e)return void console.log("error: addAndShowTmpModal: body is invalid!");var n=$('<div class="kepler modal"></div>');if(t.class&&n.addClass(t.class.toString()),t.domId&&n.attr("id",t.domId.toString()),n.append(e),t.closable){var r='<a class="close-modal">&#215;</a>',i=n.find(".topbar:first");i.length>0?i.append(r):n.prepend(r)}n.appendTo($("body")),Kepler.modal.open(n,{closeOnBackdropClick:t.closable,removeOnClose:!0,zIndex:t.zIndex}),Kepler.init()}},Bulldozer.fn.loadingIndicator=new function(){var e=!1;this.show=function(){var o=$("#bulldozer-loading-indicator");o.is(":visible")||(o.css("opacity","0").show(),e=setTimeout(function(){e=!1,o.stop().fadeTo(300,1)},1e3))},this.hide=function(){e!==!1&&clearTimeout(e);var o=$("#bulldozer-loading-indicator");o.is(":visible")&&o.stop().fadeOut(300)}},Bulldozer.fn.WebSocket=new function(){var e;this.onOpen,this.onClose,this.onMessage,this.onError,this.reset=function(){e=void 0},this.type=function(){return"websocket"},this.open=function(){try{var o="ws://";"https:"===window.location.protocol&&(o="wss://"),o+=window.location.host+"/bulldozer/ws",e=new WebSocket(o),e.onmessage=function(e){Bulldozer.WebSocket.onMessage(e.data.toString())},e.onerror=function(){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()},e.onclose=function(){Bulldozer.WebSocket.onClose&&Bulldozer.WebSocket.onClose()},e.onopen=function(){Bulldozer.WebSocket.onOpen()}}catch(t){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()}},this.send=function(o){e.send(o)}},Bulldozer.fn.AjaxSocket=new function(){var e,o,t=7e3,n=45e3,r=!1,i=!1,l={Init:"init"},s=function(){r&&r.abort(),i&&i.abort(),Bulldozer.AjaxSocket.onError()},a=function(){r=$.ajax({url:"/bulldozer/ajax/poll",success:function(e){r=!1;var t=e.indexOf("&");return 0>t?(console.log("ajaxsocket: failed to split poll token from data! '&' not found! data: "+e),void s()):(o=e.substring(0,t),e=e.substr(t+1),a(),void Bulldozer.AjaxSocket.onMessage(e))},error:function(){r=!1,s()},type:"POST",data:e+"&"+o,dataType:"text",timeout:n})},d=function(e,o){i=$.ajax({url:"/bulldozer/ajax",success:function(e){i=!1,o&&o(e)},error:function(){i=!1,s()},type:"POST",data:e,dataType:"text",timeout:t})};this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"ajaxsocket"},this.open=function(){d(l.Init,function(t){var n=t.indexOf("&");return 0>n?(console.log("ajaxsocket: failed to split uid and poll token from data! '&' not found! data: "+t),void s()):(e=t.substring(0,n),o=t.substr(n+1),a(),void Bulldozer.AjaxSocket.onOpen())})},this.send=function(o){d(e+"&"+o)}},Bulldozer.fn.socket=new function(){var e,o,t,n,r=3,i={Task:"tsk"},l={InvalidRequest:"invalid_request",Ping:"ping",Pong:"pong"},s=!1,a=!1,d=!1,u=0,c=function(e){return"sid="+o+"&tok="+n+"&"+e},v=function(){d!==!1&&clearTimeout(d),d=setTimeout(function(){d=!1,a=!0},4e4)},f=function(o){if(v(),a&&(a=!1),o){if(o===l.InvalidRequest)return void console.log("The server replied with an invalid request notification! The previous request was invalid!");var t=o.indexOf("&");if(0>t)return void Bulldozer.utils.showErrorMessageBox("Error","Warning! Invalid data received from server! Try to reload your browser and notify the site administrator!","Error data: '"+o+"'");if(n=o.substring(0,t),o=o.substr(t+1),o===l.Ping)return void e.send(c(i.Task+"="+l.Pong+"&"));o&&jQuery.globalEval(o)}},h=function(e){if(!e)return Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize socket session! Received data is emtpy!"),!1;if(e===l.InvalidRequest)return console.log("The server replied with an invalid request notification! The previous request was invalid!"),!1;var o=e.split("&");return o.length<2?(console.log("Failed to initialize socket session! Received list length is invalid: '"+e+"'"),!1):(t=o[0],n=o[1],u=0,!0)},p=function(o,t,n){return o&&e.type()!==Bulldozer.AjaxSocket.type()?(console.log("falling back to ajax socket..."),void Bulldozer.socket.init(t,n,!0)):(a=!0,void(u>r?Bulldozer.utils.showErrorMessageBox("Error","Failed to establish a connection to the server. Please reload this page and try again."):setTimeout(function(){Bulldozer.socket.init(t,n)},5e3)))};this.sessionID=function(){return o},this.init=function(t,r,i){var l=!0;return t&&r?(o=t,n=r,u+=1,e&&(e.onOpen=void 0,e.onClose=void 0,e.onMessage=void 0,e.onError=void 0,e.reset&&e.reset()),e=window.WebSocket&&i!==!0?Bulldozer.WebSocket:Bulldozer.AjaxSocket,e.onOpen=function(){l=!1,e.send(c(""))},e.onClose=function(){p(l,t,r)},e.onError=function(){console.log(e.type()+": a connection error occurred!"),p(l,t,r)},e.onMessage=function(o){return h(o)?(s||(s=!0,$(document).triggerHandler("bulldozer.ready")),void(e.onMessage=function(e){f(e)})):(e.onClose=e.onError=null,void Bulldozer.socket.reconnect())},void e.open()):void console.log("empty session ID or socket access token!")},this.send=function(o,t){var n=i.Task+"="+String(o)+"&";for(var r in t)t.hasOwnProperty(r)&&(n+=r+"="+Bulldozer.utils.escapeData(t[r])+"&");e.send(c(n))},this.reconnect=function(){$.ajax({url:"/bulldozer/reconnect",type:"POST",data:{id:t},dataType:"text",timeout:7e3,success:function(e){var o=e.split("&");return o.length<2?void console.log("Failed to reconnect socket session! Received list length is invalid: '"+e+"'"):void Bulldozer.socket.init(o[0],o[1])},error:function(){console.log("failed to reconnect to server!")}})}},Bulldozer.fn.core=new function(){var e,o=!1,t=[],n=[],r={};$(document).on("bulldozer.ready",function(){o=!0,Bulldozer.core.execJsLoad()}),$(document).on("click","a",function(e){var o=String($(this).attr("href"));return"mailto:"===o.slice(0,7)?(e.preventDefault(),window.open(o,"_blank"),!1):this.host===window.location.host&&"#"!==o.slice(0,1)&&"public/"!==o.slice(0,6)&&"/public/"!==o.slice(0,7)?(e.preventDefault(),o&&Bulldozer.core.loadPage(o),!1):void 0}),this.loadDefaultPage=function(){this.loadPage("/")},this.loadPage=function(e){Bulldozer.loadingIndicator.show();var o={path:e};Bulldozer.socket.send("page",o)},this.emit=function(){if(arguments.length<2)return void console.log("Bulldozer.emit: Invalid arguments passed! The emit function requires a DOM ID and key parameter!");for(var e={did:arguments[0],key:arguments[1]},o=2;o<arguments.length;o++)e["arg"+(o-1)]=arguments[o];Bulldozer.socket.send("emit",e)},this.loadStyleSheet=function(e){$('<link rel="stylesheet" type="text/css" href="'+e+'">').appendTo("head")},this.loadScript=function(e,o){var n={url:e,callback:o};t.push(n);var r=function(e,o){var n={dataType:"script",cache:!0,url:e},i=function(){t.length>0?r(t[0].url,t[0].callback):Bulldozer.core.execJsLoad()};jQuery.ajax(n).done(function(){t.shift(),o&&o(),i()}).fail(function(o,n,r){t.shift(),Bulldozer.utils.showErrorMessageBox("Error","Failed to load script '"+e+"'. Please contact the site administrator!","Error message: "+String(r)),i()})};t.length<=1&&r(e,o)},$(window).on("beforeunload",function(){return e?e:void 0}),this.setExitMessage=function(o){e=String(o)},this.resetExitMessage=function(){e=""},this.execJsLoad=function(e){setTimeout(function(){t.length>0||!o?e&&n.push(e.toString()):($.each(n,function(e,o){$("#"+o).triggerHandler("bulldozer.execJsLoad")}),n=[],e&&$("#"+e).triggerHandler("bulldozer.execJsLoad"),setTimeout(function(){Bulldozer.loadingIndicator.hide()},50))},10)},this.onJsLoad=function(e,o){$("#"+e).one("bulldozer.execJsLoad",o)},this.execJsUnload=function(e){$("#"+e).triggerHandler("bulldozer.execJsUnload")},this.onJsUnload=function(e,o){$("#"+e).one("bulldozer.execJsUnload",o),$(document).one("bulldozer.execJsUnload",o)},this.addServerEvent=function(e,o,t){var n=$("#"+e);if(n.length<=0)return void console.log("addServerEvent: element with id '"+e+"' does not exists!");var r=n.data("bulldozerserverevents");r||(r={}),r[o]=t,n.data("bulldozerserverevents",r)},this.emitServerEvent=function(e,o){var t=$("#"+e);if(t.length<=0)return void console.log("emitServerEvent: element with id '"+e+"' does not exists!");var n=t.data("bulldozerserverevents");if(!n)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");if(func=n[o],!func)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");var r=Array.prototype.slice.call(arguments,2);func.apply(t,r)},this.addGlobalServerEvent=function(e,o){r[e]=o},this.emitGlobalServerEvent=function(e){if(func=r[e],!func)return void console.log("emitGlobalServerEvent: event with key '"+e+"' does not exists!");var o=Array.prototype.slice.call(arguments,1);func.apply(document,o)}},Bulldozer.fn.render=new function(){var e,o,t=!1,n=!1;$(window).on("statechange",function(){if(!t){var e=History.getState().hash;e||(e="/"),Bulldozer.core.loadPage(e)}});var r=function(){var e=$("#bulldozer-body");n||(e.replaceWith('<div id="bulldozer-body"></div>'),e=$("#bulldozer-body"),n=!0),$("#bulldozer-top").length<=0&&e.append('<div id="bulldozer-top"></div>'),$("#bulldozer-pages-body").length<=0&&e.append('<div id="bulldozer-pages-body"></div>'),$("#bulldozer-bottom").length<=0&&e.append('<div id="bulldozer-bottom"></div>')};this.currentPageUrl=function(){return o},this.updateTemplate=function(e,o){var t=$("#"+e);return t.length<=0?void Bulldozer.utils.showErrorMessageBox("Error","Failed to update template: '"+e+"'. Try to reload the page and please contact the site administrator!"):(Bulldozer.core.execJsUnload(e),t.replaceWith(o),void Kepler.init())},this.top=function(e){var o=$("#bulldozer-top");o.length<=0&&(r(),o=$("#bulldozer-top")),o.html(e)},this.bottom=function(e){var o=$("#bulldozer-bottom");o.length<=0&&(r(),o=$("#bulldozer-bottom")),o.html(e)},this.page=function(n,i,l,s){$(document).triggerHandler("bulldozer.execJsUnload"),$(".bulldozer-page").remove(),e&&e.length>0&&(e.off(),e.find("*").off());var a;if($("body").children().each(function(){a=$(this).attr("id"),"bulldozer-loading-indicator"!==a&&"bulldozer-body"!==a&&$(this).remove()}),$("#bulldozer-pages-body > #"+n).length>0)$("#"+n).replaceWith(i);else{var d=$("#bulldozer-pages-body");d.length<=0&&(r(),d=$("#bulldozer-pages-body")),d.append(i)}e=$("#"+n),e.show(),window.scrollTo(0,0),s&&o!==s&&(o=s,t=!0,History.pushState(null,null,s),t=!1),document.title=l,Kepler.init()}};