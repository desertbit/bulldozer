var Bulldozer=new function(){this.fn=Object.getPrototypeOf(this),this.utils};Bulldozer.utils={escapeData:function(e){return e.toString().replace(/\\|&/g,"\\$&")},showErrorMessageBox:function(e,o,t){e=Kepler.utils.escapeHTML(e),o=Kepler.utils.escapeHTML(o);var n='<div class="topbar alert"><div class="icon"></div><div class="title"><h3>'+e+'</h3></div></div><div class="kepler grid"><div class="large-12 column"><p>'+o+"</p>";t&&(n+="<br><code>"+Kepler.utils.escapeHTML(t)+"</code>"),n+='</div><div class="large-12 column"><hr></hr></div><div class="large-12 column"><a class="kepler button expand close-modal">OK</a></div></div>',this.addAndShowTmpModal(n,{closable:!1,zIndex:10001})},addAndShowTmpModal:function(e,o){var t=$.extend({domId:!1,closable:!0,"class":"radius shadow",zIndex:"auto"},o);if(!e)return void console.log("error: addAndShowTmpModal: body is invalid!");var n=$('<div class="kepler modal"></div>');if(t.class&&n.addClass(t.class.toString()),t.domId&&n.attr("id",t.domId.toString()),n.append(e),t.closable){var r='<a class="close-modal">&#215;</a>',i=n.find(".topbar:first");i.length>0?i.append(r):n.prepend(r)}n.appendTo($("body")),Kepler.modal.open(n,{closeOnBackdropClick:t.closable,removeOnClose:!0,zIndex:t.zIndex}),Kepler.init()}},Bulldozer.fn.loadingIndicator=new function(){var e=!1;this.show=function(){var o=$("#bulldozer-loading-indicator");o.is(":visible")||(o.css("opacity","0").show(),e=setTimeout(function(){e=!1,o.stop().fadeTo(300,1)},1e3))},this.hide=function(){e!==!1&&clearTimeout(e);var o=$("#bulldozer-loading-indicator");o.is(":visible")&&o.stop().fadeOut(300)}},Bulldozer.fn.WebSocket=new function(){var e;this.onOpen,this.onClose,this.onMessage,this.onError,this.reset=function(){e=void 0},this.type=function(){return"websocket"},this.open=function(){try{var o="ws://";"https:"===window.location.protocol&&(o="wss://"),o+=window.location.host+"/bulldozer/ws",e=new WebSocket(o),e.onmessage=function(e){Bulldozer.WebSocket.onMessage(e.data.toString())},e.onerror=function(){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()},e.onclose=function(){Bulldozer.WebSocket.onClose&&Bulldozer.WebSocket.onClose()},e.onopen=function(){Bulldozer.WebSocket.onOpen()}}catch(t){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()}},this.send=function(o){e.send(o)}},Bulldozer.fn.AjaxSocket=new function(){var e,o,t=7e3,n=45e3,r=!1,i=!1,s={Init:"init"},l=function(){r&&r.abort(),i&&i.abort(),Bulldozer.AjaxSocket.onError()},a=function(){r=$.ajax({url:"/bulldozer/ajax/poll",success:function(e){r=!1;var t=e.indexOf("&");return 0>t?(console.log("ajaxsocket: failed to split poll token from data! '&' not found! data: "+e),void l()):(o=e.substring(0,t),e=e.substr(t+1),a(),void Bulldozer.AjaxSocket.onMessage(e))},error:function(){r=!1,l()},type:"POST",data:e+"&"+o,dataType:"text",timeout:n})},d=function(e,o){i=$.ajax({url:"/bulldozer/ajax",success:function(e){i=!1,o&&o(e)},error:function(){i=!1,l()},type:"POST",data:e,dataType:"text",timeout:t})};this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"ajaxsocket"},this.open=function(){d(s.Init,function(t){var n=t.indexOf("&");return 0>n?(console.log("ajaxsocket: failed to split uid and poll token from data! '&' not found! data: "+t),void l()):(e=t.substring(0,n),o=t.substr(n+1),a(),void Bulldozer.AjaxSocket.onOpen())})},this.send=function(o){d(e+"&"+o)}},Bulldozer.fn.socket=new function(){var e,o,t,n=3,r={Task:"tsk"},i={InvalidRequest:"invalid_request",Ping:"ping",Pong:"pong"},s=!1,l=!1,a=0,d=function(e){return"sid="+o+"&tok="+t+"&"+e},c=function(){l!==!1&&clearTimeout(l),l=setTimeout(function(){l=!1,s=!0},4e4)},u=function(o){if(c(),s&&(s=!1),o){if(o===i.InvalidRequest)return void console.log("The server replied with an invalid request notification! The previous request was invalid!");var n=o.indexOf("&");if(0>n)return void Bulldozer.utils.showErrorMessageBox("Error","Warning! Invalid data received from server! Try to reload your browser and notify the site administrator!","Error data: '"+o+"'");if(t=o.substring(0,n),o=o.substr(n+1),o===i.Ping)return void e.send(d(r.Task+"="+i.Pong+"&"));o&&jQuery.globalEval(o)}},f=function(e){return e?e===i.InvalidRequest?(console.log("The server replied with an invalid request notification! The previous request was invalid!"),Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize socket session! Please reload this page and try again.","Error data: '"+e+"'"),!1):(t=e,a=0,!0):(Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize socket session! Received data is emtpy!"),!1)},v=function(o,t,r){return o&&e.type()!==Bulldozer.AjaxSocket.type()?(console.log("falling back to ajax socket..."),void Bulldozer.socket.init(t,r,!0)):(s=!0,void(a>n?Bulldozer.utils.showErrorMessageBox("Error","Failed to establish a connection to the server. Please reload this page and try again."):setTimeout(function(){Bulldozer.socket.init(t,r)},5e3)))};this.sessionID=function(){return o},this.init=function(n,r,i){var s=!0;return n&&r?(o=n,t=r,a+=1,e&&(e.onOpen=void 0,e.onClose=void 0,e.onMessage=void 0,e.onError=void 0,e.reset&&e.reset()),e=window.WebSocket&&i!==!0?Bulldozer.WebSocket:Bulldozer.AjaxSocket,e.onOpen=function(){s=!1,e.send(d(""))},e.onClose=function(){v(s,n,r)},e.onError=function(){console.log(e.type()+": a connection error occurred!"),v(s,n,r)},e.onMessage=function(o){f(o)&&(e.onMessage=function(e){u(e)})},void e.open()):void console.log("empty session ID or socket access token!")},this.send=function(o,t){var n=r.Task+"="+String(o)+"&";for(var i in t)t.hasOwnProperty(i)&&(n+=i+"="+Bulldozer.utils.escapeData(t[i])+"&");e.send(d(n))}},Bulldozer.fn.core=new function(){var e,o=[],t=[],n={};$(document).on("click","a",function(e){var o=String($(this).attr("href"));return"mailto:"===o.slice(0,7)?(e.preventDefault(),window.open(o,"_blank"),!1):this.host===window.location.host&&"#"!==o.slice(0,1)&&"public/"!==o.slice(0,6)&&"/public/"!==o.slice(0,7)?(e.preventDefault(),o&&Bulldozer.core.loadPage(o),!1):void 0}),this.loadDefaultPage=function(){this.loadPage("/")},this.loadPage=function(e){Bulldozer.loadingIndicator.show();var o={path:e};Bulldozer.socket.send("page",o)},this.emit=function(){if(arguments.length<2)return void console.log("Bulldozer.emit: Invalid arguments passed! The emit function requires a DOM ID and key parameter!");for(var e={did:arguments[0],key:arguments[1]},o=2;o<arguments.length;o++)e["arg"+(o-1)]=arguments[o];Bulldozer.socket.send("emit",e)},this.loadStyleSheet=function(e){$('<link rel="stylesheet" type="text/css" href="'+e+'">').appendTo("head")},this.loadScript=function(e,t){var n={url:e,callback:t};o.push(n);var r=function(e,t){var n={dataType:"script",cache:!0,url:e},i=function(){o.length>0?r(o[0].url,o[0].callback):Bulldozer.core.execJsLoad()};jQuery.ajax(n).done(function(){o.shift(),t&&t(),i()}).fail(function(t,n,r){o.shift(),Bulldozer.utils.showErrorMessageBox("Error","Failed to load script '"+e+"'. Please contact the site administrator!","Error message: "+String(r)),i()})};o.length<=1&&r(e,t)},$(window).on("beforeunload",function(){return e?e:void 0}),this.setExitMessage=function(o){e=String(o)},this.resetExitMessage=function(){e=""},this.execJsLoad=function(e){setTimeout(function(){o.length>0?e&&t.push(e.toString()):($.each(t,function(e,o){$("#"+o).triggerHandler("bulldozer.execJsLoad")}),t=[],e&&$("#"+e).triggerHandler("bulldozer.execJsLoad"),setTimeout(function(){Bulldozer.loadingIndicator.hide()},50))},10)},this.onJsLoad=function(e,o){$("#"+e).one("bulldozer.execJsLoad",o)},this.execJsUnload=function(e){$("#"+e).triggerHandler("bulldozer.execJsUnload")},this.onJsUnload=function(e,o){$("#"+e).one("bulldozer.execJsUnload",o),$(document).one("bulldozer.execJsUnload",o)},this.addServerEvent=function(e,o,t){var n=$("#"+e);if(n.length<=0)return void console.log("addServerEvent: element with id '"+e+"' does not exists!");var r=n.data("bulldozerserverevents");r||(r={}),r[o]=t,n.data("bulldozerserverevents",r)},this.emitServerEvent=function(e,o){var t=$("#"+e);if(t.length<=0)return void console.log("emitServerEvent: element with id '"+e+"' does not exists!");var n=t.data("bulldozerserverevents");if(!n)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");if(func=n[o],!func)return void console.log("emitServerEvent: event with key '"+o+"' does not exists!");var r=Array.prototype.slice.call(arguments,2);func.apply(t,r)},this.addGlobalServerEvent=function(e,o){n[e]=o},this.emitGlobalServerEvent=function(e){if(func=n[e],!func)return void console.log("emitGlobalServerEvent: event with key '"+e+"' does not exists!");var o=Array.prototype.slice.call(arguments,1);func.apply(document,o)}};