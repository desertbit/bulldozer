var Bulldozer=new function(){this.fn=Object.getPrototypeOf(this),this.utils};Bulldozer.utils={escapeData:function(o){return o.toString().replace(/\\|&/g,"\\$&")},showErrorMessageBox:function(o,e,n){o=Kepler.utils.escapeHTML(o),e=Kepler.utils.escapeHTML(e);var t='<div class="topbar alert"><div class="icon"></div><div class="title"><h3>'+o+'</h3></div></div><div class="kepler grid"><div class="large-12 column"><p>'+e+"</p>";n&&(t+="<br><code>"+Kepler.utils.escapeHTML(n)+"</code>"),t+='</div><div class="large-12 column"><hr></hr></div><div class="large-12 column"><a class="kepler button expand close-modal">OK</a></div></div>',this.addAndShowTmpModal(t,{closable:!1,zIndex:10001})},addAndShowTmpModal:function(o,e){var n=$.extend({domId:!1,closable:!0,"class":"radius shadow",zIndex:"auto"},e);if(!o)return void console.log("error: addAndShowTmpModal: body is invalid!");var t=$('<div class="kepler modal"></div>');if(n.class&&t.addClass(n.class.toString()),n.domId&&t.attr("id",n.domId.toString()),t.append(o),n.closable){var i='<a class="close-modal">&#215;</a>',r=t.find(".topbar:first");r.length>0?r.append(i):t.prepend(i)}t.appendTo($("body")),Kepler.modal.open(t,{closeOnBackdropClick:n.closable,removeOnClose:!0,zIndex:n.zIndex}),Kepler.init()}},Bulldozer.fn.loadingIndicator=new function(){var o=!1;this.show=function(){var e=$("#bulldozer-loading-indicator");e.is(":visible")||(e.css("opacity","0").show(),o=setTimeout(function(){o=!1,e.stop().fadeTo(300,1)},1e3))},this.hide=function(){o!==!1&&clearTimeout(o);var e=$("#bulldozer-loading-indicator");e.is(":visible")&&e.stop().fadeOut(300)}},Bulldozer.fn.WebSocket=new function(){var o;this.onOpen,this.onClose,this.onMessage,this.onError,this.reset=function(){o=void 0},this.type=function(){return"websocket"},this.open=function(){try{var e="ws://";"https:"===window.location.protocol&&(e="wss://"),e+=window.location.host+"/bulldozer/ws",o=new WebSocket(e),o.onmessage=function(o){Bulldozer.WebSocket.onMessage(o.data.toString())},o.onerror=function(){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()},o.onclose=function(){Bulldozer.WebSocket.onClose&&Bulldozer.WebSocket.onClose()},o.onopen=function(){Bulldozer.WebSocket.onOpen()}}catch(n){Bulldozer.WebSocket.onError&&Bulldozer.WebSocket.onError()}},this.send=function(e){o.send(e)}},Bulldozer.fn.AjaxSocket=new function(){var o,e,n=7e3,t=45e3,i=!1,r=!1,s={Init:"init"},a=function(){i&&i.abort(),r&&r.abort(),Bulldozer.AjaxSocket.onError()},l=function(){i=$.ajax({url:"/bulldozer/ajax/poll",success:function(o){i=!1;var n=o.indexOf("&");return 0>n?(console.log("ajaxsocket: failed to split poll token from data! '&' not found! data: "+o),void a()):(e=o.substring(0,n),o=o.substr(n+1),l(),void Bulldozer.AjaxSocket.onMessage(o))},error:function(){i=!1,a()},type:"POST",data:o+"&"+e,dataType:"text",timeout:t})},d=function(o,e){r=$.ajax({url:"/bulldozer/ajax",success:function(o){r=!1,e&&e(o)},error:function(){r=!1,a()},type:"POST",data:o,dataType:"text",timeout:n})};this.onOpen,this.onClose,this.onMessage,this.onError,this.type=function(){return"ajaxsocket"},this.open=function(){d(s.Init,function(n){var t=n.indexOf("&");return 0>t?(console.log("ajaxsocket: failed to split uid and poll token from data! '&' not found! data: "+n),void a()):(o=n.substring(0,t),e=n.substr(t+1),l(),void Bulldozer.AjaxSocket.onOpen())})},this.send=function(e){d(o+"&"+e)}},Bulldozer.fn.socket=new function(){var o,e,n,t=3,i={Task:"tsk"},r={InvalidRequest:"invalid_request",Ping:"ping",Pong:"pong"},s=!1,a=!1,l=0,d=function(o){return"sid="+e+"&tok="+n+"&"+o},c=function(){a!==!1&&clearTimeout(a),a=setTimeout(function(){a=!1,s=!0},4e4)},u=function(e){if(c(),s&&(s=!1),e){if(e===r.InvalidRequest)return void console.log("The server replied with an invalid request notification! The previous request was invalid!");var t=e.indexOf("&");if(0>t)return void Bulldozer.utils.showErrorMessageBox("Error","Warning! Invalid data received from server! Try to reload your browser and notify the site administrator!","Error data: '"+e+"'");if(n=e.substring(0,t),e=e.substr(t+1),e===r.Ping)return void o.send(d(i.Task+"="+r.Pong+"&"));e&&jQuery.globalEval(e)}},f=function(o){return o?o===r.InvalidRequest?(console.log("The server replied with an invalid request notification! The previous request was invalid!"),Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize socket session! Please reload this page and try again.","Error data: '"+o+"'"),!1):(n=o,l=0,!0):(Bulldozer.utils.showErrorMessageBox("Error","Failed to initialize socket session! Received data is emtpy!"),!1)},p=function(e,n,i){return e&&o.type()!==Bulldozer.AjaxSocket.type()?(console.log("falling back to ajax socket..."),void Bulldozer.socket.init(n,i,!0)):(s=!0,void(l>t?Bulldozer.utils.showErrorMessageBox("Error","Failed to establish a connection to the server. Please reload this page and try again."):setTimeout(function(){Bulldozer.socket.init(n,i)},5e3)))};this.sessionID=function(){return e},this.init=function(t,i,r){var s=!0;return t&&i?(e=t,n=i,l+=1,o&&(o.onOpen=void 0,o.onClose=void 0,o.onMessage=void 0,o.onError=void 0,o.reset&&o.reset()),o=window.WebSocket&&r!==!0?Bulldozer.WebSocket:Bulldozer.AjaxSocket,o.onOpen=function(){s=!1,o.send(d(""))},o.onClose=function(){p(s,t,i)},o.onError=function(){console.log(o.type()+": a connection error occurred!"),p(s,t,i)},o.onMessage=function(e){f(e)&&(o.onMessage=function(o){u(o)})},void o.open()):void console.log("empty session ID or socket access token!")},this.send=function(e,n){var t=i.Task+"="+String(e)+"&";for(var r in n)n.hasOwnProperty(r)&&(t+=r+"="+Bulldozer.utils.escapeData(n[r])+"&");o.send(d(t))}};